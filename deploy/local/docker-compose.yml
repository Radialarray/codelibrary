version: '3.8'
services:
  # Frontend
  # w eb:
  #   container_name: web
  #   build:
  #     context: .
  #     dockerfile: ./apps/web/Dockerfile
  #   volumes:
  #     - .:/app
  #     - /app/node_modules
  #   restart: always
  #   ports:
  #     - 3000:3000

  # CMS
  cms_caddy:
    container_name: cms_caddy
    image: caddy:2.6.2
    restart: unless-stopped
    networks:
      - my-bridge-network
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - codelibrary:/srv/
      - ./deploy/hfg/Caddyfile:/etc/caddy/Caddyfile
    env_file:
      - ./.env
    depends_on:
      - cms_php_fpm

  cms_composer_installation:
    container_name: cms_composer_installation
    image: composer
    user: '1000:1000'
    networks:
      - my-bridge-network
    volumes:
      - codelibrary:/app
    command: composer install --ignore-platform-reqs

  cms_php_fpm:
    container_name: cms_php_fpm
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - my-bridge-network
    env_file:
      - ./.env
    volumes:
      - codelibrary:/srv/
      - ./.user.ini:/usr/local/etc/php/conf.d/.user.ini
    depends_on:
      - cms_composer_installation
volumes:
  codelibrary:
    # external: true
    # name: codelibrary
    # driver: local
    # driver_opts:
    #   type: cifs
    #   device: '//${BACKEND_SHARE_REMOTE_DOMAIN}/${BACKEND_SHARE_PATH_TO_LIBRARY}'
    #   o: 'addr=${BACKEND_SHARE_REMOTE_HOST},username=${BACKEND_SHARE_USER},password=${BACKEND_SHARE_PASSWORD},file_mode=0777,dir_mode=0777,vers=3.0'
    # name: codelibrary
    # driver: local
    # driver_opts:
    #   type: cifs
    #   device: '//iot-share/Share_CodeLibrary'
    #   o: 'addr=172.17.172.21,username=${BACKEND_SHARE_USER},password=${BACKEND_SHARE_PASSWORD}'
    name: codelibrary
    driver_opts:
      type: cifs
      o: 'username=${BACKEND_SHARE_USER},password=${BACKEND_SHARE_PASSWORD}'
      device: '//${BACKEND_SHARE_REMOTE_HOST}/${BACKEND_SHARE_PATH_TO_LIBRARY}'
networks:
  my-bridge-network:
    external: true
