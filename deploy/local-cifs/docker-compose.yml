version: '3.8'
services:
  # Frontend
  # web:
  #   container_name: web
  #   build:
  #     context: .
  #     dockerfile: ./apps/web/Dockerfile
  #   volumes:
  #     - .:/app
  #     - /app/node_modules
  #   restart: always
  #   ports:
  #     - 3000:3000

  # CMS
  cms_caddy:
    container_name: cms_caddy
    image: caddy:2.6.2
    restart: unless-stopped
    networks:
      - my-bridge-network
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - codelibrary:/srv/
      - ./Caddyfile:/etc/caddy/Caddyfile
    env_file:
      - ./.env
    depends_on:
      - cms_php_fpm

  cms_composer_installation:
    container_name: cms_composer_installation
    image: composer
    user: '1000:1000'
    networks:
      - my-bridge-network
    volumes:
      - codelibrary:/app
    command: composer install --ignore-platform-reqs

  cms_php_fpm:
    container_name: cms_php_fpm
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - my-bridge-network
    env_file:
      - ./.env
    volumes:
      - codelibrary:/srv/
      - ./.user.ini:/usr/local/etc/php/conf.d/.user.ini
    depends_on:
      - cms_composer_installation
volumes:
  codelibrary:
    name: codelibrary
    driver: local
    driver_opts:
      type: 'cifs'
      device: '//${BACKEND_SHARE_REMOTE_DOMAIN}/${BACKEND_SHARE_PATH_TO_LIBRARY}'
      o: 'addr=${BACKEND_SHARE_REMOTE_IP},username=${BACKEND_SHARE_USER},password=${BACKEND_SHARE_PASSWORD}'
networks:
  my-bridge-network:
    driver: bridge
    ipam:
      config:
        - subnet: '172.42.238.0/24'
